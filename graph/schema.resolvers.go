package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.70

import (
	"context"
	"errors"
	"fmt"
	"strconv"
	"trello-backend/graph/model"
	"trello-backend/pkg/utils"
)

// 型別轉換工具
func intToInt32(i int) int32    { return int32(i) }
func strToPtr(s string) *string { return &s }
func ptrToStr(s *string) string {
	if s == nil {
		return ""
	} else {
		return *s
	}
}

// 取得 userID string from context
func UserIDFromContext(ctx context.Context) (string, bool) {
	uid, ok := ctx.Value(struct{ UserID string }{}).(string)
	return uid, ok
}

// CreateBoard is the resolver for the createBoard field.
func (r *mutationResolver) CreateBoard(ctx context.Context, input model.CreateBoardInput) (*model.Board, error) {
	userID, ok := UserIDFromContext(ctx)
	if !ok {
		return nil, errors.New("未驗證身份")
	}
	b, err := r.BoardService.CreateBoard(input.Name, userID)
	if err != nil {
		return nil, err
	}
	return &model.Board{
		ID:        strconv.FormatUint(uint64(b.ID), 10),
		Name:      b.Name,
		CreatedAt: b.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: b.UpdatedAt.Format(utils.TimeFormat),
	}, nil
}

// UpdateBoard is the resolver for the updateBoard field.
func (r *mutationResolver) UpdateBoard(ctx context.Context, input model.UpdateBoardInput) (*model.Board, error) {
	id, err := strconv.ParseUint(input.ID, 10, 64)
	if err != nil {
		return nil, err
	}
	err = r.BoardService.UpdateBoard(uint(id), input.Name)
	if err != nil {
		return nil, err
	}
	b, err := r.BoardService.GetBoard(uint(id))
	if err != nil {
		return nil, err
	}
	return &model.Board{
		ID:        strconv.FormatUint(uint64(b.ID), 10),
		Name:      b.Name,
		CreatedAt: b.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: b.UpdatedAt.Format(utils.TimeFormat),
	}, nil
}

// DeleteBoard is the resolver for the deleteBoard field.
func (r *mutationResolver) DeleteBoard(ctx context.Context, id string) (bool, error) {
	bid, err := strconv.ParseUint(id, 10, 64)
	if err != nil {
		return false, err
	}
	err = r.BoardService.DeleteBoard(uint(bid))
	return err == nil, err
}

// CreateList is the resolver for the createList field.
func (r *mutationResolver) CreateList(ctx context.Context, input model.CreateListInput) (*model.List, error) {
	bid, err := strconv.ParseUint(input.BoardID, 10, 64)
	if err != nil {
		return nil, err
	}
	l, err := r.ListService.CreateList(uint(bid), input.Name)
	if err != nil {
		return nil, err
	}
	return &model.List{
		ID:        strconv.FormatUint(uint64(l.ID), 10),
		Name:      l.Name,
		BoardID:   strconv.FormatUint(uint64(l.BoardID), 10),
		CreatedAt: l.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: l.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(l.Position),
	}, nil
}

// UpdateList is the resolver for the updateList field.
func (r *mutationResolver) UpdateList(ctx context.Context, input model.UpdateListInput) (*model.List, error) {
	id, err := strconv.ParseUint(input.ID, 10, 64)
	if err != nil {
		return nil, err
	}
	err = r.ListService.UpdateList(uint(id), input.Name)
	if err != nil {
		return nil, err
	}
	l, err := r.ListService.GetListByID(uint(id))
	if err != nil {
		return nil, err
	}
	return &model.List{
		ID:        strconv.FormatUint(uint64(l.ID), 10),
		Name:      l.Name,
		BoardID:   strconv.FormatUint(uint64(l.BoardID), 10),
		CreatedAt: l.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: l.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(l.Position),
	}, nil
}

// DeleteList is the resolver for the deleteList field.
func (r *mutationResolver) DeleteList(ctx context.Context, id string) (bool, error) {
	lid, err := strconv.ParseUint(id, 10, 64)
	if err != nil {
		return false, err
	}
	err = r.ListService.DeleteList(uint(lid))
	return err == nil, err
}

// MoveList is the resolver for the moveList field.
func (r *mutationResolver) MoveList(ctx context.Context, input model.MoveListInput) (*model.List, error) {
	id, err := strconv.ParseUint(input.ID, 10, 64)
	if err != nil {
		return nil, err
	}
	err = r.ListService.MoveList(uint(id), int(input.NewPosition))
	if err != nil {
		return nil, err
	}
	l, err := r.ListService.GetListByID(uint(id))
	if err != nil {
		return nil, err
	}
	return &model.List{
		ID:        strconv.FormatUint(uint64(l.ID), 10),
		Name:      l.Name,
		BoardID:   strconv.FormatUint(uint64(l.BoardID), 10),
		CreatedAt: l.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: l.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(l.Position),
	}, nil
}

// CreateCard is the resolver for the createCard field.
func (r *mutationResolver) CreateCard(ctx context.Context, input model.CreateCardInput) (*model.Card, error) {
	lid, err := strconv.ParseUint(input.ListID, 10, 64)
	if err != nil {
		return nil, err
	}
	c, err := r.CardService.CreateCard(uint(lid), input.Title, ptrToStr(input.Content))
	if err != nil {
		return nil, err
	}
	return &model.Card{
		ID:        strconv.FormatUint(uint64(c.ID), 10),
		Title:     c.Title,
		Content:   strToPtr(c.Content),
		ListID:    strconv.FormatUint(uint64(c.ListID), 10),
		CreatedAt: c.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: c.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(c.Position),
	}, nil
}

// UpdateCard is the resolver for the updateCard field.
func (r *mutationResolver) UpdateCard(ctx context.Context, input model.UpdateCardInput) (*model.Card, error) {
	id, err := strconv.ParseUint(input.ID, 10, 64)
	if err != nil {
		return nil, err
	}
	err = r.CardService.UpdateCard(uint(id), input.Title, ptrToStr(input.Content))
	if err != nil {
		return nil, err
	}
	c, err := r.CardService.GetCardByID(uint(id))
	if err != nil {
		return nil, err
	}
	return &model.Card{
		ID:        strconv.FormatUint(uint64(c.ID), 10),
		Title:     c.Title,
		Content:   strToPtr(c.Content),
		ListID:    strconv.FormatUint(uint64(c.ListID), 10),
		CreatedAt: c.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: c.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(c.Position),
	}, nil
}

// DeleteCard is the resolver for the deleteCard field.
func (r *mutationResolver) DeleteCard(ctx context.Context, id string) (bool, error) {
	cid, err := strconv.ParseUint(id, 10, 64)
	if err != nil {
		return false, err
	}
	err = r.CardService.DeleteCard(uint(cid))
	return err == nil, err
}

// MoveCard is the resolver for the moveCard field.
func (r *mutationResolver) MoveCard(ctx context.Context, input model.MoveCardInput) (*model.Card, error) {
	id, err := strconv.ParseUint(input.ID, 10, 64)
	if err != nil {
		return nil, err
	}
	targetListID, err := strconv.ParseUint(input.TargetListID, 10, 64)
	if err != nil {
		return nil, err
	}
	err = r.CardService.MoveCard(uint(id), uint(targetListID), int(input.NewPosition))
	if err != nil {
		return nil, err
	}
	c, err := r.CardService.GetCardByID(uint(id))
	if err != nil {
		return nil, err
	}
	return &model.Card{
		ID:        strconv.FormatUint(uint64(c.ID), 10),
		Title:     c.Title,
		Content:   strToPtr(c.Content),
		ListID:    strconv.FormatUint(uint64(c.ListID), 10),
		CreatedAt: c.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: c.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(c.Position),
	}, nil
}

// Boards 查詢
func (r *queryResolver) Boards(ctx context.Context) ([]*model.Board, error) {
	userID, ok := UserIDFromContext(ctx)
	if !ok {
		return nil, errors.New("未驗證身份")
	}
	fmt.Println("userID:", userID) // 印出標準 UUID 字串格式
	// ...你的查詢邏輯...
	return []*model.Board{}, nil
}

// Board is the resolver for the board field.
func (r *queryResolver) Board(ctx context.Context, id string) (*model.Board, error) {
	boardID, err := strconv.ParseUint(id, 10, 64)
	if err != nil {
		return nil, err
	}
	b, err := r.BoardService.GetBoard(uint(boardID))
	if err != nil {
		return nil, err
	}
	return &model.Board{
		ID:        strconv.FormatUint(uint64(b.ID), 10),
		Name:      b.Name,
		CreatedAt: b.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: b.UpdatedAt.Format(utils.TimeFormat),
	}, nil
}

// Lists is the resolver for the lists field.
func (r *queryResolver) Lists(ctx context.Context, boardID string) ([]*model.List, error) {
	bid, err := strconv.ParseUint(boardID, 10, 64)
	if err != nil {
		return nil, err
	}
	lists, err := r.ListService.GetLists(uint(bid))
	if err != nil {
		return nil, err
	}
	result := make([]*model.List, 0, len(lists))
	for _, l := range lists {
		result = append(result, &model.List{
			ID:        strconv.FormatUint(uint64(l.ID), 10),
			Name:      l.Name,
			BoardID:   strconv.FormatUint(uint64(l.BoardID), 10),
			CreatedAt: l.CreatedAt.Format(utils.TimeFormat),
			UpdatedAt: l.UpdatedAt.Format(utils.TimeFormat),
			Position:  intToInt32(l.Position),
		})
	}
	return result, nil
}

// List is the resolver for the list field.
func (r *queryResolver) List(ctx context.Context, id string) (*model.List, error) {
	listID, err := strconv.ParseUint(id, 10, 64)
	if err != nil {
		return nil, err
	}
	l, err := r.ListService.GetListByID(uint(listID))
	if err != nil {
		return nil, err
	}
	return &model.List{
		ID:        strconv.FormatUint(uint64(l.ID), 10),
		Name:      l.Name,
		BoardID:   strconv.FormatUint(uint64(l.BoardID), 10),
		CreatedAt: l.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: l.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(l.Position),
	}, nil
}

// Cards is the resolver for the cards field.
func (r *queryResolver) Cards(ctx context.Context, listID string) ([]*model.Card, error) {
	lid, err := strconv.ParseUint(listID, 10, 64)
	if err != nil {
		return nil, err
	}
	cards, err := r.CardService.GetCards(uint(lid))
	if err != nil {
		return nil, err
	}
	result := make([]*model.Card, 0, len(cards))
	for _, c := range cards {
		result = append(result, &model.Card{
			ID:        strconv.FormatUint(uint64(c.ID), 10),
			Title:     c.Title,
			Content:   strToPtr(c.Content),
			ListID:    strconv.FormatUint(uint64(c.ListID), 10),
			CreatedAt: c.CreatedAt.Format(utils.TimeFormat),
			UpdatedAt: c.UpdatedAt.Format(utils.TimeFormat),
			Position:  intToInt32(c.Position),
		})
	}
	return result, nil
}

// Card is the resolver for the card field.
func (r *queryResolver) Card(ctx context.Context, id string) (*model.Card, error) {
	cid, err := strconv.ParseUint(id, 10, 64)
	if err != nil {
		return nil, err
	}
	c, err := r.CardService.GetCardByID(uint(cid))
	if err != nil {
		return nil, err
	}
	return &model.Card{
		ID:        strconv.FormatUint(uint64(c.ID), 10),
		Title:     c.Title,
		Content:   strToPtr(c.Content),
		ListID:    strconv.FormatUint(uint64(c.ListID), 10),
		CreatedAt: c.CreatedAt.Format(utils.TimeFormat),
		UpdatedAt: c.UpdatedAt.Format(utils.TimeFormat),
		Position:  intToInt32(c.Position),
	}, nil
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
